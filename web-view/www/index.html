<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地HTML页面</title>
    <script>
        function receiveStatusBarHeight(height) {
            document.getElementById('statusBarHeight').textContent = '状态栏高度: ' + height + 'px';
            console.log('从Swift接收到的状态栏高度:', height);
        }
        
        // 创建通用对象acjsapi来调用Swift暴露的方法，使用Proxy来动态处理方法调用
        const acjsapi = new Proxy({
            // 存储回调函数的映射
            _callbacks: new Map(),
            _callbackId: 0,
            
            // 生成唯一的回调ID
            _generateCallbackId: function() {
                return 'cb_' + this._callbackId++;
            },
            
            // 调用Swift方法
            _call: function(methodName, ...args) {
                return new Promise((resolve, reject) => {
                    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers[methodName]) {
                        const callbackId = this._generateCallbackId();
                        this._callbacks.set(callbackId, { resolve, reject });
                        
                        // 发送消息给Swift，包括回调ID和参数
                        window.webkit.messageHandlers[methodName].postMessage({
                            callbackId: callbackId,
                            args: args
                        });
                    } else {
                        reject(new Error(`方法 ${methodName} 不可用`));
                    }
                });
            },
            
            // 接收Swift的回调
            callback: function(callbackId, result, error) {
                if (this._callbacks.has(callbackId)) {
                    const { resolve, reject } = this._callbacks.get(callbackId);
                    if (error) {
                        reject(new Error(error));
                    } else {
                        resolve(result);
                    }
                    this._callbacks.delete(callbackId);
                }
            }
        }, {
            get: function(target, property, receiver) {
                if (typeof property === 'string' && property !== 'callback' && !property.startsWith('_')) {
                    return function(...args) {
                        return target._call(property, ...args);
                    };
                }
                return Reflect.get(target, property, receiver);
            }
        });
        
        // 暴露acjsapi到全局作用域
        window.acjsapi = acjsapi;
        
        // 当页面加载完成后，尝试获取状态栏高度
        window.onload = async function() {
            try {
                const height = await acjsapi.getStatusBarHeight();
                receiveStatusBarHeight(height);
            } catch (error) {
                console.error(error.message);
            }
        };
    </script>
</head>
<body>
    <h1>欢迎使用本地HTML页面</h1>
    <p>这是WebView加载的本地内容。</p>
    <p id="statusBarHeight">状态栏高度: 未知</p>
</body>
</html>